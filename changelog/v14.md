# v14 — AI state machine with LOS, sound propagation, and flanking

**Category:** feature

## Changes

- Full AI state machine replacing simple behavior lookups: patrol → alert → hunting
- **Bresenham line-of-sight**: enemies only detect player through clear LOS, not through walls
- **Sound propagation**: combat alerts nearby enemies within radius (8 for melee, 10 for sentinel fire, 12 for EMP)
- **3 AI states** with visual indicators:
  - `patrol` — enemies walk between rooms, unaware of player
  - `alert` (?) — enemy heard combat or lost sight, investigates last known position for 8 turns
  - `hunting` (!) — enemy has LOS to player, actively chasing/attacking
- **Tracker flanking**: at close range (≤4 tiles) trackers approach from perpendicular direction instead of straight line
- **Smart pathfinding**: moveToward tries primary direction, then perpendicular alternatives when blocked by walls
- **Sight ranges**: drone=8, tracker=20, sentinel=6 — trackers are the long-range threat
- **Sentinel awareness**: stationary but shoots when alert or hunting, idle when patrolling
- **Self-defense instinct**: any enemy adjacent to uncloaked player attacks regardless of AI state
- Enemies avoid stepping onto player's tile (no more "bump attack" — attack is explicit action)

### AI behavior per enemy type

- **Drone** (d): patrols between rooms → chases when sees player → attacks when adjacent
- **Tracker** (t): 20-tile sight range → flanks from perpendicular at close range → relentless pursuit
- **Sentinel** (S): stationary turret → shoots cardinal lines when alert/hunting → idle on patrol

## Reasoning

Player wanted "real AI simulation — stalking, traps, attacks, super smart enemies." Previous system used simple behavior functions with no awareness model — enemies either chased blindly or stood still. The state machine creates emergent gameplay: combat in one room alerts enemies in adjacent rooms, trackers circle around to flank, and sentinels only activate when they detect a threat. The `!` and `?` indicators give the player tactical information to plan movement and module usage.

## Files modified

- `game.js` — AI system (hasLOS, moveToward, flankTarget, randomStep, propagateSound, computeEnemyAction), rewritten enemyTurn, AI state fields in populateFloor, propagateSound calls in attackEnemy/sentinelShoot/EMP
- `render.js` — AI state indicators above enemies (! for hunting, ? for alert)
- `data.js` — behavior registrations removed (already done in prep), behavior field retained as string tag
